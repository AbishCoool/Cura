{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Appointments</title>

  <link rel="stylesheet" href="{% static 'assets/css/styles.css' %}">
  <link rel="stylesheet" href="{% static 'assets/css/activity.css' %}"><!-- reuse Activity look -->

  <!-- Defensive styles in case activity.css misses these classes -->
  <style>
    .dynamic-list-container { display: flex; flex-direction: column; gap: 10px; padding: 0 4px; }
    .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-radius: 12px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
    .item-left { display: flex; flex-direction: column; gap: 4px; }
    .item-title { font-weight: 700; color: #3a2370; }
    .item-sub { font-size: 12px; color: #4b3d79; opacity: .85; }
    .item-right { display: flex; align-items: center; gap: 8px; }
    .time-chip { font-size: 12px; padding: 6px 10px; border-radius: 9999px; background: #eef3ff; }
  </style>

  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

  <!-- Your Firebase init -->
  <script src="{% static 'assets/firebase/firebase-config.js' %}"></script>
</head>

<body
  data-firebase-id="{{ firebase_id }}"
  data-is-family="{{ is_family|lower }}"
  data-main-user-id="{% if is_family %}{{ user_profile.user.id }}{% else %}{{ user_profile.user.id }}{% endif %}">
  
  <div class="container">
    <div class="header">
      {% if is_family %}
        <a href="{% url 'famil' %}" class="back-button">&#8592;</a>
      {% else %}
        <a href="{% url 'home' user_profile.user.id %}" class="back-button">&#8592;</a>
      {% endif %}
      <div class="title-card">
        <h1>My Appointments</h1>
        <img src="{% static 'assets/images/activity.png' %}" alt="Calendar Icon">
      </div>
    </div>

    <!-- Activity-style list container -->
    <div id="appointment-list" class="dynamic-list-container">
      <p class="empty-text">Loading appointments...</p>
    </div>
  </div>

  <script>
  async function fetchAppointments() {
    const listEl = document.getElementById('appointment-list');
    const firebaseId = document.body.getAttribute('data-firebase-id');
    const isFamilyMember = document.body.getAttribute('data-is-family') === 'true';
    const mainUserId = document.body.getAttribute('data-main-user-id');

    if (!firebaseId) {
      listEl.innerHTML = '<p class="empty-text">Error: Patient ID not found.</p>';
      return;
    }

    try {
      const userIdToUse = isFamilyMember ? String(mainUserId) : String(firebaseId);
      const familyFilterValue = isFamilyMember ? String(firebaseId) : null;

      let ref = window.db.collection('appointmentSchedules')
        .where('userId', '==', userIdToUse)
        .where('familyMemberId', '==', familyFilterValue);

      // Try ordered (best); if Firestore asks for index, fall back
      try {
        const snap = await ref.orderBy('datetime', 'desc').get();
        renderSnap(snap, listEl);
        return;
      } catch (e) {
        console.warn('Ordered query failed; falling back:', e && e.message);
      }

      const snap = await ref.get();
      const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a,b) => new Date(b.datetime) - new Date(a.datetime));
      renderArray(docs, listEl);
    } catch (err) {
      console.error('Error fetching appointments:', err);
      listEl.innerHTML = '<p class="empty-text">Error loading appointments. Please try again.</p>';
    }
  }

  function renderSnap(snap, container) {
    if (snap.empty) {
      container.innerHTML = '<p class="empty-text">No appointments scheduled.</p>';
      return;
    }
    container.innerHTML = '';
    snap.forEach(doc => container.appendChild(rowFromData(doc.data())));
  }

  function renderArray(arr, container) {
    if (!arr.length) {
      container.innerHTML = '<p class="empty-text">No appointments scheduled.</p>';
      return;
    }
    container.innerHTML = '';
    arr.forEach(d => container.appendChild(rowFromData(d)));
  }

  // Activity-style row (title + sub + right chip)
  function rowFromData(data) {
    const dt = data?.datetime ? new Date(data.datetime) : null;
    const when = dt
      ? dt.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
      : '-';

    const row = document.createElement('div');
    row.className = 'list-item';
    row.innerHTML = `
      <div class="item-left">
        <div class="item-title">${escapeHtml(data.doctorName || 'Doctor')}</div>
        <div class="item-sub">
          ${escapeHtml(data.location || '-')}${data.reason ? ' • ' + escapeHtml(data.reason) : ' • Appointment'}
        </div>
      </div>
      <div class="item-right">
        <span class="time-chip">${when}</span>
      </div>
    `;
    return row;
  }

  // small sanitiser for safety
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  document.addEventListener('DOMContentLoaded', fetchAppointments);
  </script>
</body>
</html>
